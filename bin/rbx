#!/bin/bash

RBX_USAGE="Access frequently used Roblox dev programs & commands

USAGE:
    rbx [subcommand]

COMMANDS:
	build		Build the rojo project 
	run 		Builds the project and opens the file in Roblox Studio
	studio		Opens a file in Roblox Studio
	tarmac		Wraps Tarmac commands with better defaults
	import		Runs the script located at remodel/import.sh (TEMPORARY)
	refresh		Runs the script located at remodel/refresh.sh (TEMPORARY)
	test		Executes the build command and then runs 'run-tests.lua' in Roblox Studio"

BUILD_USAGE="Build the Rojo project

USAGE:
	rbx build [project_name] [file_name]

ARGS:
	[project_name]
		Name of the project to build. Defaults to 'default'
	[file_name]
		Name of the file to be written to. Defaults to the value of project_name"

RUN_USAGE="Builds the project and opens the file in Roblox Studio.

USAGE:
	rbx run [project_name]

ARGS:
	[project_name]
		Name of the project to run. Defaults to 'default'
	[file_name]
		Name of the file to be written to. Defaults to the value of project_name"

TARMAC_USAGE="Wraps Tarmac commands with better defaults

USAGE:
	tarmac [subcommand]

COMMANDS:
	sync"

platform=''

sys="$(uname -sr)"
case "${sys}" in
	Linux*microsoft)
		platform="wsl"
		;;
	Linux*)
		platform="linux"
		;;
	CYGWIN*|MINGW*|MSYS*)
		platform="windows"
		;;
	Darwin*)
		platform="mac"
		;;
	*)
		platform="unknown"
		;;
esac

roblosecurity() {
	token=''
	case "${platform}" in
		windows|wsl)
			reg_cmd='reg'
			if [[ -x "$(command -v reg.exe)" ]]; then
				reg_cmd='reg.exe'
			fi
			token="$(${reg_cmd} query 'HKCU\SOFTWARE\Roblox\RobloxStudioBrowser\roblox.com' -v .ROBLOSECURITY)"
			;;
		linux)
			token="$(awk -F: '/^".ROBLOSECURITY"=/{print}' "${HOME}"/.local/share/grapejuice/prefixes/studio/user.reg)"
			;;
	esac
	token="${token#*COOK::<}"
	echo "${token%>*}"
}

open_place() {
	case "${platform}" in
		windows|wsl)
			start_cmd='start'
			if [[ -x "$(command -v start.exe)" ]]; then
				start_cmd='start.exe'
			fi
			"${start_cmd}" "${1}"
			;;
		linux)
			env LOG_LEVEL="WARNING" grapejuice studio "${PWD}/${1}"
			;;
		mac)
			open "${1}"
			;;
	esac
}

build() {
	rojo --version
	mkdir -p build
	rojo build "${1:-default}.project.json" -o "build/${2:-${1:-default}}.rbxl"
}

run() {
	build "${@}"
	open_place "build/${2:-${1:-default}}.rbxl"
}

test() {
	rir=''
	case "${platform}" in
		windows|wsl)
			rir='run-in-roblox'
			if [[ -x "$(command -v run-in-roblox.exe)" ]]; then
				rir='run-in-roblox.exe'
			fi
			;;
		linux)
			;;
	esac

	if [[ "${rir}" ]]; then
		build "${1}" "${1:-default}-test"
		"${rir}" --version
		"${rir}" --place "build/${1:-default}.rbxl" --script "run-tests.lua"
	else
		echo "A run-in-roblox installation was not found on this system"
	fi
}

tarmac_sync() {
	tarmac sync --target roblox --auth "$(roblosecurity)" --retry 3 --retry-delay 5
}

case "${1}" in
	build)
		case "${2}" in
			--help)
				echo "${BUILD_USAGE}"
				;;
			*)
				build "${@:2}"
				;;
		esac
		;;
	run)
		case "${2}" in
			--help)
				echo "${RUN_USAGE}"
				;;
			*)
				run "${@:2}"
				;;
		esac
		;;
	test)
		test "${2}"
		;;
	studio)
		open_place "${@:2}"
		;;
	tarmac)
		case "${2}" in
			sync)
				tarmac_sync
				;;
			*)
				echo "${TARMAC_USAGE}"
				;;
		esac
		;;
	import)
		env REMODEL_AUTH="$(roblosecurity)" remodel/import.sh "${@:2}"
		;;
	refresh)
		env REMODEL_AUTH="$(roblosecurity)" remodel/refresh.sh "${@:2}"
		;;
	*)
		echo "${RBX_USAGE}"
		;;
esac

